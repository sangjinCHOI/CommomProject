<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.ssafy.persona.character.mapper.CharacterMapper">

	<insert id="regist" useGeneratedKeys="true" keyProperty="characterSeq">
		insert into tb_character
			(user_seq, category_seq, nickname, introduction, character_created_date)
		values
			(#{userSeq}, #{categorySeq}, #{nickname}, #{introduction}, now())
	</insert>

	<update id="update">
		update tb_character set
		<if test="nickname != null and nickname != ''">
			nickname=#{nickname},
		</if>
		<if test="introduction != null and introduction != ''">
			introduction=#{introduction},
		</if>
		<if
			test="representativeAchievement != null and representativeAchievement != ''">
			representative_achievement=#{representativeAchievement},
		</if>
		character_modified_date = now()
		where character_seq=#{characterSeq}
	</update>

	<update id="delete">
		update tb_character set
			character_active=0,
			character_delete_reason=#{characterDeleteReason},
			character_modified_date = now()
		where character_seq=#{characterSeq}
	</update>

	<select id="detail"	resultType="CharacterGetResponse">
		select c.character_seq, c.user_seq, c.nickname, c.category_seq, c.introduction, 
			c.representative_achievement, c.alarm_allow, c.like_alarm, c.reply_alarm,
			c.follow_alarm, c.modify_alarm, c.reported_time, character_active,
			c.character_created_date, c.character_modified_date,
			u.user_id,
			f.file_path
		from
			tb_character c
		JOIN tb_user u ON c.user_seq = u.user_seq
		LEFT OUTER JOIN tb_file f ON f.relation_tb = 'tb_character'
		AND f.relation_seq = c.character_seq
		where character_seq=#{characterSeq} 
		AND character_active = 1
	</select>

	<select id="getCharacterProfile" resultType="CharacterProfileResponse">
		select 
			c.character_seq,
			c.representative_achievement, 
			f.file_path AS achievement_image,
			ca.character_category_name AS category_name,
			(SELECT count(*) FROM tb_content where character_seq = c.character_seq AND content_is_active = 1) AS content_count,
			(SELECT count(*) FROM tb_follow where followee = c.character_seq) AS follower_count,
			(SELECT count(*) FROM tb_follow where follower = c.character_seq) AS followee_count
		from
			tb_character c
		LEFT OUTER JOIN tb_character_category ca ON ca.character_category_seq = c.category_seq
		LEFT OUTER JOIN tb_file f ON f.relation_tb = 'tb_achievement'
		AND f.relation_seq = c.representative_achievement
		where nickname=#{nickname} 
		AND character_active = 1
	</select>

	<select id="list"
		resultType="com.ssafy.persona.character.model.dto.CharacterGetResponse">
		select c.character_seq, c.user_seq, c.nickname, c.category_seq, c.introduction, 
			c.representative_achievement, c.alarm_allow, c.like_alarm, c.reply_alarm,
			c.follow_alarm, c.modify_alarm, c.reported_time, character_active,
			c.character_created_date, c.character_modified_date,
			f.file_path
		from tb_character c
		LEFT OUTER JOIN tb_file f ON f.relation_tb = 'tb_character'
		AND f.relation_seq = c.character_seq
		where user_seq=#{userSeq}
		AND character_active = 1
	</select>

	<select id="getCharacterCount"	resultType="int">
		select 
			count(*)
		from
			tb_character
		where user_seq=#{userSeq}
		and character_active = 1
	</select>

	<select id="checkCharacterNickname"	resultType="int">
		select 
			count(*)
		from
			tb_character
		where nickname=#{nickname}
		and character_active = 1
	</select>

</mapper>